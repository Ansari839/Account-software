// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  address            String?
  phone              String?
  email              String?
  website            String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  departments        Department[]
  employees          Employee[]
  customers          Customer[]
  suppliers          Supplier[]
  products           Product[]
  salesOrders        SalesOrder[]
  salesReturns       SalesReturn[]
  purchaseOrders     PurchaseOrder[]
  goodsReceipts      GoodsReceipt[]
  customerLedgers    CustomerLedger[]
  supplierLedgers    SupplierLedger[]
  categories         Category[]
  batches            Batch[]
  stockMovements     StockMovement[]
  stockLedgers       StockLedger[]
  deliveryChallans   DeliveryChallan[]
  chartOfAccounts    ChartOfAccount[]
  journalVouchers    JournalVoucher[]
  cashBooks          CashBook[]
  bankBooks          BankBook[]
  dispatchEntries    DispatchEntry[]
  gatepasses         Gatepass[]
  vehicleAssignments VehicleAssignment[]
  deliveryStatuses   DeliveryStatus[]
  reportLogs         ReportLog[]
  auditLogs          AuditLog[]
  systemSettings     SystemSetting[]
  importExportLogs   ImportExportLog[]
}

model Department {
  id          String     @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]
}

model Role {
  id          String     @id @default(cuid())
  name        String
  description String?
  permissions String[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]
}

model Employee {
  id                  String           @id @default(cuid())
  firstName           String
  lastName            String
  email               String           @unique
  phone               String?
  address             String?
  hireDate            DateTime
  salary              Decimal?
  companyId           String
  departmentId        String
  roleId              String
  company             Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department          Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  role                Role             @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  salesOrders         SalesOrder[]     @relation("SalesOrdersCreatedBy")
  salesReturns        SalesReturn[]    @relation("SalesReturnsCreatedBy")
  purchaseOrders      PurchaseOrder[]  @relation("PurchaseOrdersCreatedBy")
  goodsReceipts       GoodsReceipt[]   @relation("GoodsReceiptsCreatedBy")
  approvedSalesOrders SalesOrder[]     @relation("SalesOrdersApprovedBy")
  journalVouchers     JournalVoucher[]
}

model Customer {
  id              String           @id @default(cuid())
  name            String
  email           String           @unique
  phone           String?
  address         String?
  companyId       String
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  salesOrders     SalesOrder[]
  salesReturns    SalesReturn[]
  customerLedgers CustomerLedger[]
}

model Supplier {
  id              String           @id @default(cuid())
  name            String
  email           String
  phone           String?
  address         String?
  companyId       String
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  purchaseOrders  PurchaseOrder[]
  goodsReceipts   GoodsReceipt[]
  supplierLedgers SupplierLedger[]
}

model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Product {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  sku                String              @unique
  price              Decimal // Sales price
  cost               Decimal? // Purchase cost
  openingStock       Int                 @default(0)
  minStock           Int                 @default(0)
  unit               String // e.g. pcs, kg, liters
  stock              Int                 @default(0)
  companyId          String
  category           Category?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId         String?
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  orderItems         OrderItem[]
  returnItems        ReturnItem[]
  purchaseOrderItems PurchaseOrderItem[]
  goodsReceiptItems  GoodsReceiptItem[]
  batches            Batch[]
  stockMovements     StockMovement[]
  stockLedgers       StockLedger[]
}

model SalesOrder {
  id                   String            @id @default(cuid())
  orderNumber          String            @unique
  date                 DateTime          @default(now())
  status               String            @default("pending") // pending, confirmed, shipped, delivered, cancelled
  customerId           String
  customer             Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  companyId            String
  company              Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salesPersonId        String
  salesPerson          Employee          @relation("SalesOrdersCreatedBy", fields: [salesPersonId], references: [id], onDelete: Cascade)
  approvedById         String?
  approvedBy           Employee?         @relation("SalesOrdersApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  orderItems           OrderItem[]
  totalAmount          Decimal           @default(0)
  notes                String?
  expectedDeliveryDate DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  salesReturns         SalesReturn[] // For linking sales returns to this order
  deliveryChallans     DeliveryChallan[]
}

model OrderItem {
  id           String     @id @default(cuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity     Int
  unitPrice    Decimal
  total        Decimal    @default(0)
  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model SalesReturn {
  id           String       @id @default(cuid())
  returnNumber String       @unique
  date         DateTime     @default(now())
  reason       String?
  status       String       @default("pending") // pending, approved, processed
  salesOrderId String?
  salesOrder   SalesOrder?  @relation(fields: [salesOrderId], references: [id], onDelete: SetNull)
  customerId   String
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  companyId    String
  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy    String
  creator      Employee     @relation("SalesReturnsCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  returnItems  ReturnItem[]
  totalAmount  Decimal      @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model ReturnItem {
  id            String      @id @default(cuid())
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity      Int
  unitPrice     Decimal
  total         Decimal     @default(0)
  salesReturnId String
  salesReturn   SalesReturn @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model DeliveryChallan {
  id            String     @id @default(cuid())
  challanNumber String     @unique
  salesOrderId  String
  salesOrder    SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  date          DateTime   @default(now())
  status        String     @default("pending") // pending, delivered, completed
  companyId     String
  company       Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

model PurchaseOrder {
  id               String              @id @default(cuid())
  orderNumber      String              @unique
  date             DateTime            @default(now())
  status           String              @default("pending") // pending, confirmed, partially_received, received, cancelled
  supplierId       String
  supplier         Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  companyId        String
  company          Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchasePersonId String
  purchasePerson   Employee            @relation("PurchaseOrdersCreatedBy", fields: [purchasePersonId], references: [id], onDelete: Cascade)
  orderItems       PurchaseOrderItem[]
  totalAmount      Decimal             @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  goodsReceipts    GoodsReceipt[]
}

model PurchaseOrderItem {
  id                String             @id @default(cuid())
  productId         String
  product           Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity          Int
  unitPrice         Decimal
  total             Decimal            @default(0)
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  receivedQty       Int                @default(0) // Quantity received against this item
  goodsReceiptItems GoodsReceiptItem[] // For linking goods receipt items to this purchase order item
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model GoodsReceipt {
  id              String             @id @default(cuid())
  grnNumber       String             @unique
  date            DateTime           @default(now())
  status          String             @default("pending") // pending, confirmed, approved
  purchaseOrderId String
  purchaseOrder   PurchaseOrder      @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier           @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  receivedById    String
  receiver        Employee           @relation("GoodsReceiptsCreatedBy", fields: [receivedById], references: [id], onDelete: Cascade)
  items           GoodsReceiptItem[]
  batches         Batch[] // For linking batches to GRN
  totalAmount     Decimal            @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model GoodsReceiptItem {
  id                  String            @id @default(cuid())
  productId           String
  product             Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity            Int
  unitPrice           Decimal
  total               Decimal           @default(0)
  goodsReceiptId      String
  goodsReceipt        GoodsReceipt      @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  purchaseOrderItemId String
  purchaseOrderItem   PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id], onDelete: Cascade)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model CustomerLedger {
  id              String   @id @default(cuid())
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactionType String // sales_order, sales_return, payment, etc.
  referenceId     String // ID of the related transaction
  description     String?
  debit           Decimal  @default(0)
  credit          Decimal  @default(0)
  balance         Decimal  @default(0)
  date            DateTime @default(now())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SupplierLedger {
  id              String   @id @default(cuid())
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  transactionType String // purchase_order, goods_receipt, payment, etc.
  referenceId     String // ID of the related transaction
  description     String?
  debit           Decimal  @default(0) // Amount the company owes to supplier
  credit          Decimal  @default(0) // Amount supplier owes to company (returns, credits)
  balance         Decimal  @default(0) // Running balance
  date            DateTime @default(now())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Batch {
  id                String          @id @default(cuid())
  batchNumber       String
  expiryDate        DateTime?
  manufacturingDate DateTime?
  quantity          Int             @default(0)
  productId         String
  product           Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  goodsReceiptId    String?
  goodsReceipt      GoodsReceipt?   @relation(fields: [goodsReceiptId], references: [id], onDelete: SetNull)
  companyId         String
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  stockMovements    StockMovement[]
}

model StockMovement {
  id            String        @id @default(cuid())
  productId     String
  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchId       String?
  batch         Batch?        @relation(fields: [batchId], references: [id], onDelete: SetNull)
  quantity      Int
  movementType  String // 'IN' or 'OUT'
  referenceType String // 'purchase_order', 'goods_receipt', 'sales_order', 'sales_return', 'adjustment'
  referenceId   String // ID of the related transaction
  description   String?
  date          DateTime      @default(now())
  companyId     String
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  stockLedgers  StockLedger[] // One-to-many relation with StockLedger
}

model StockLedger {
  id              String         @id @default(cuid())
  productId       String
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  date            DateTime       @default(now())
  transactionType String // 'purchase_order', 'goods_receipt', 'sales_order', 'sales_return', 'adjustment'
  referenceId     String // ID of the related transaction
  description     String?
  qtyIn           Int            @default(0)
  qtyOut          Int            @default(0)
  balance         Int            @default(0) // Running balance
  companyId       String
  company         Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  stockMovementId String?
  stockMovement   StockMovement? @relation(fields: [stockMovementId], references: [id], onDelete: SetNull)
}

model ChartOfAccount {
  id                    String                @id @default(uuid())
  name                  String
  type                  String
  parentId              String?
  parent                ChartOfAccount?       @relation("ParentChild", fields: [parentId], references: [id], onDelete: SetNull)
  children              ChartOfAccount[]      @relation("ParentChild")
  companyId             String
  company               Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  journalVoucherEntries JournalVoucherEntry[]
}

model JournalVoucher {
  id            String                @id @default(uuid())
  voucherNumber String                @unique
  date          DateTime              @default(now())
  description   String?
  companyId     String
  company       Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  entries       JournalVoucherEntry[]
  totalDebit    Decimal               @default(0)
  totalCredit   Decimal               @default(0)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  createdById   String
  createdBy     Employee              @relation(fields: [createdById], references: [id], onDelete: Cascade)
}

model JournalVoucherEntry {
  id               String         @id @default(uuid())
  journalVoucherId String
  journalVoucher   JournalVoucher @relation(fields: [journalVoucherId], references: [id], onDelete: Cascade)
  accountId        String
  account          ChartOfAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  debit            Decimal        @default(0)
  credit           Decimal        @default(0)
  description      String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model CashBook {
  id            String   @id @default(uuid())
  date          DateTime @default(now())
  description   String?
  debit         Decimal  @default(0)
  credit        Decimal  @default(0)
  balance       Decimal  @default(0)
  referenceType String? // 'journal_voucher', 'sales_order', etc.
  referenceId   String? // ID of the related transaction
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BankBook {
  id            String   @id @default(uuid())
  date          DateTime @default(now())
  bankName      String
  description   String?
  debit         Decimal  @default(0)
  credit        Decimal  @default(0)
  balance       Decimal  @default(0)
  referenceType String? // 'journal_voucher', 'sales_order', etc.
  referenceId   String? // ID of the related transaction
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model DispatchEntry {
  id                 String              @id @default(uuid())
  orderNumber        String // Reference to SalesOrder.orderNumber
  date               DateTime            @default(now())
  status             String              @default("pending") // pending, dispatched, in-transit, out-for-delivery, delivered
  companyId          String
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  gatepasses         Gatepass[]
  vehicleAssignments VehicleAssignment[]
  deliveryStatuses   DeliveryStatus[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model Gatepass {
  id            String        @id @default(uuid())
  dispatchId    String
  dispatch      DispatchEntry @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  vehicleNumber String
  driverName    String
  date          DateTime      @default(now())
  status        String        @default("active") // active, expired
  companyId     String
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model VehicleAssignment {
  id            String         @id @default(uuid())
  vehicleNumber String
  driverName    String
  dispatchId    String?
  dispatch      DispatchEntry? @relation(fields: [dispatchId], references: [id], onDelete: SetNull)
  companyId     String
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model DeliveryStatus {
  id         String        @id @default(uuid())
  dispatchId String
  dispatch   DispatchEntry @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  status     String // pending, in-transit, out-for-delivery, delivered
  companyId  String
  company    Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

model ReportLog {
  id          String   @id @default(uuid())
  reportType  String
  generatedAt DateTime @default(now())
  generatedBy String
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  module    String
  timestamp DateTime @default(now())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String
  value     String
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ImportExportLog {
  id        String   @id @default(uuid())
  type      String
  fileName  String
  timestamp DateTime @default(now())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
